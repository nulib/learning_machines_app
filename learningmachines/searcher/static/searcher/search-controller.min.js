var qry,size,selected_database;async function renderDataBaseSelect(dbdata){console.log("hello:",dbdata),console.log(special_access),access_obj=JSON.parse(special_access),console.log(access_obj),removelist=["CCHMC","Med_Applications","Mayerson","Mayerson_qna"],access_obj.forEach((function(d){removelist[d]=""})),removelist.forEach((function(d){d.length>0&&delete dbdata[d]}));let search_year_end="year",search_year_start="year";var height=40,dbBtsDiv,dbBtns,dbdivs=d3.select("#select-db").selectAll("div").data(Object.keys(dbdata)).enter().append("div").attr("class","col-9 col-lg-3 col-md-3 col-sm-3 p-3").attr("id",(function(d){return d+"_btn"})).append("div").attr("class","btn btn-secondary db-button row h-100 card p-3").style("background-color",(function(d){return dbdata[d].color})).style("border-color","white").style("text-align","center").style("max-width","100%").style("white-space","normal");$(".next").on("click",(function(e){let currentSection,db;e.preventDefault(),showContinue($(".side-nav-active").attr("id").replace("-nav",""),"next"),renderSearchInput($(".db-button.selected").attr("id").replace("_btn",""),dbdata,!1)}));let formatter=d3.format(".3s"),dbLabels=dbdivs.append("div").attr("class","db_label col-12 card-body").style("max-width","100%").style("display","inline");dbLabels.append("h6").style("display","inline-block").classed("pp card-text",!0).text((function(d){return dbdata[d].name})),dbLabels.append("p").style("display","inline-block").classed("pp card-text",!0).text((function(d){return console.log(d),": "+formatter(database_runtimes[d].count)+" docs"})),dbLabels.append("p").classed("dataset-btn-p card-text  align-middle",!0).style("overflow-wrap","break-word").text((function(d){yearExt=d3.extent(Object.keys(database_years[d]),(function(d){return d}));var yearstr="";return null!=yearExt[0]&&(yearstr=yearExt[0]+"-"+yearExt[1]+": "),yearstr+database_runtimes[d].description}));let dbthings,dbsvgs=dbdivs.append("div").attr("class","col-12").style("height","0px").append("svg").attr("class","db_svg").attr("id",(function(d){return d+"_svg"})).style("height","0px").style("width","100%");Object.keys(dbdata).forEach((function(n){yearExt=d3.extent(Object.keys(database_years[n]),(function(d){return d})),countMax=d3.max(Object.keys(database_years[n]),(function(d){return database_years[n][d]}));var gwidth=$("#"+n+"_svg").width(),padding_left=15,padding_right=10,padding_top=5,padding_bottom=8;if(null!=yearExt[0]){var xScale=d3.scaleLinear().domain(yearExt).range([0+padding_left,gwidth-padding_left-padding_right]),yScale=d3.scaleLinear().domain([0,countMax]).range([40-padding_top-padding_bottom,0+padding_bottom]),line=d3.line().x((function(d){return xScale(d)})).y((function(d){return yScale(database_years[n][d])}));d3.select("#"+n+"_svg").append("path").datum(Object.keys(database_years[n])).attr("class","line").attr("d",line),d3.select("#"+n+"_svg").append("circle").attr("cx",xScale(yearExt[0])).attr("cy",(function(){return yScale(database_years[n][Object.keys(database_years[n])[0]])})).attr("r",2),d3.select("#"+n+"_svg").append("circle").attr("cx",xScale(yearExt[1])).attr("cy",(function(){return yScale(database_years[n][Object.keys(database_years[n])[Object.keys(database_years[n]).length-1]])})).attr("r",2);var maxIndex=0;d3.select("#"+n+"_svg").append("circle").attr("cx",(function(){for(var i=0;i<Object.keys(database_years[n]).length;i++)if(database_years[n][Object.keys(database_years[n])[i]]==countMax)return xScale(Object.keys(database_years[n])[i])})).attr("cy",(function(){return yScale(countMax)})).style("fill","blue").attr("r",2),d3.select("#"+n+"_svg").append("text").attr("x",xScale(yearExt[0])).attr("y",(function(){return yScale(database_years[n][Object.keys(database_years[n])[0]])})).attr("dy","-1px").attr("class","graphtext").attr("text-anchor","end").text(yearExt[0]),d3.select("#"+n+"_svg").append("text").attr("x",xScale(yearExt[1])).attr("y",(function(){return yScale(database_years[n][Object.keys(database_years[n])[Object.keys(database_years[n]).length-1]])})).attr("dy","-1px").attr("class","graphtext").attr("text-anchor","start").text(yearExt[1]);var maxIndex=0;d3.select("#"+n+"_svg").append("text").attr("x",(function(){for(var i=0;i<Object.keys(database_years[n]).length;i++)if(database_years[n][Object.keys(database_years[n])[i]]==countMax)return xScale(Object.keys(database_years[n])[i])})).attr("dy","-1px").attr("class","graphtext").attr("text-anchor","start").attr("y",(function(){return yScale(countMax)})).style("fill","blue").text(countMax)}else d3.select("#"+n+"_svg").append("text").attr("x",20).attr("y",20).text("No Time Data")})),fromhistory&&$("#"+loaded.database+"_btn").trigger("click")}async function getArticles(qry,dbn,fromhistory,timeExt,size){$("#search-qry").text(""==qry?"' '":qry),$("#loading-img").removeClass("hidden"),$("#time-graph").addClass("hidden"),$("#min-count-graph").addClass("hidden"),$("#explore-docs-btn-div").addClass("hidden"),$("#explore-docs-time").addClass("hidden");let journal_select=$("#journal-options-select").val(),jurisdiction_select=$("#law-options-select").val();loaded.filter_pk=1,getA(dbn,qry,timeExt,size)}async function getA(dbn,qry,timeExt,size){console.log("Function started");let journal_select=$("#journal-options-select").val();console.log("journal_select: ",journal_select),console.log(d3);let jurisdiction_select=$("#law-options-select").val(),auth_search_qry=$("#search-author").val(),family_select=$("#family-options-select").val(),min_care_rating=$("#care_rating_low").val(),max_care_rating=-1;search_year_start=$("#start-year").val(),search_year_end=$("#end-year").val();var rgxp=new RegExp(/\d{2,}/,"g");null==timeExt?(search_year_end="year",search_year_start="year"):0==count(search_year_start,rgxp)||0==count(search_year_end,rgxp)?(search_year_end="year",search_year_start="year"):search_year_start==timeExt[0]&&search_year_end==timeExt[1]&&(search_year_end="year",search_year_start="year");let qry_str="/searcher/process_search?database="+dbn+"&qry="+qry+"&min_care_rating="+min_care_rating+"&max_care_rating="+-1+"&start="+search_year_start+"&end="+search_year_end+"&maximum_hits="+size+"&journal="+journal_select+"&auth_s="+auth_search_qry+"&family="+family_select+"&jurisdiction="+jurisdiction_select+query_id_str+"&filter_pk="+loaded.filter_pk;console.log(qry_str);let articles=await d3.json(qry_str);console.log(articles),$("#loading-img").addClass("hidden"),$("#time-graph").removeClass("hidden"),$("#min-count-graph").removeClass("hidden"),$("#explore-docs-btn-div").removeClass("hidden"),$("#explore-docs-time").removeClass("hidden"),renderFilterDocs(articles,dbn,qry),console.log("getA function has completed")}function renderSearchInput(d,dbdata){$("#search-term").off("keyup"),$(".doc-button").off("click"),$("#archaeology-row-div select").val("all"),$("#caselaw-row-div select").val("all"),$("#db-search-label").text(dbdata[d].name),$("#search-term").focus((function(e){$(this).css("border","1px solid "+dbdata[d].color),$(this).css("box-shadow","0 0 10px "+dbdata[d].color)})),$(".doc-button").css("background-color",dbdata[d].color),"Care_Reviews"==d?($("#carereview-row-div").removeClass("hidden"),$("#archaeology-row-div").addClass("hidden"),$("#caselaw-row-div").addClass("hidden"),$("#family-row-div").addClass("hidden")):"Archaeology"==d?($("#archaeology-row-div").removeClass("hidden"),$("#caselaw-row-div").addClass("hidden"),$("#coi-row-div").addClass("hidden"),$("#family-row-div").addClass("hidden"),$("#search-term-div").removeClass("hidden"),$("#carereview-row-div").addClass("hidden")):"Pubmed_COI"==d?($("#coi-row-div").removeClass("hidden"),$("#search-term-div").removeClass("hidden"),$("#family-row-div").addClass("hidden"),$("#coi-row-div").on("input",(function(d){$("#search-term-div").addClass("hidden"),$("#search-term").val("")})),$("#archaeology-row-div").addClass("hidden"),$("#caselaw-row-div").addClass("hidden"),$("#carereview-row-div").addClass("hidden")):"Med_Applications"==d?($("#coi-row-div").addClass("hidden"),$("#caselaw-row-div").addClass("hidden"),$("#archaeology-row-div").addClass("hidden"),$("#search-term-div").removeClass("hidden"),$("#family-row-div").removeClass("hidden"),$("#carereview-row-div").addClass("hidden")):($("#coi-row-div").addClass("hidden"),$("#caselaw-row-div").addClass("hidden"),$("#archaeology-row-div").addClass("hidden"),$("#family-row-div").addClass("hidden"),$("#carereview-row-div").addClass("hidden"),$("#search-term-div").removeClass("hidden")),$(".doc-button").click((function(e){qry=$("#search-term").val(),size=(size=$(this).attr("id")).split("-")[1],selected_database=d,showContinue("filter-docs"),getArticles(qry,d,fromhistory,timeExt,size)})),$("#search-term").on("keyup",(function(e){13==e.keyCode&&$("#docs-5000").trigger("click")}));var timeExt=d3.extent(Object.keys(database_years[d]),(function(d){return parseInt(d)}));null!=timeExt[0]?($("#slider-div").removeClass("hidden"),$("#start-year").val(timeExt[0]),$("#end-year").val(timeExt[1])):($("#start-year").val("year"),$("#end-year").val("year"),$("#slider-div").addClass("hidden")),fromhistory&&("year"!=loaded.start&&($("#start-year").val(loaded.start),$("#end-year").val(loaded.end)),$("#archaeology-row-div select").val(loaded.journal),$("#caselaw-row-div select").val(loaded.jurisdiction),$("#search-term").val(loaded.qry),console.log(loaded.maximum_hits),console.log($("#docs-"+loaded.maximum_hits)),setTimeout((function(){$("#docs-"+loaded.maximum_hits).trigger("click")}),1e3))}function renderFilterDocs(articles,dbn,qry){var total_articles=articles.results.length,docCount=dc.dataCount(".dc-doc-count"),timeChart=dc.barChart("#time-graph"),minSelect=dc.barChart("#min-count-graph"),dateFormat=d3.timeFormat("%Y-%m-%d"),dateFormatParser=d3.timeParse(dateFormat),numberFormat=d3.format(".2f"),maxCount=0;articles.results.forEach((function(d){d.date=dateFormatParser(d.date),d.min_term_occurrence>maxCount&&(maxCount=d.min_term_occurrence)}));var respd=crossfilter(articles.results),all=respd.groupAll(),countDimension=respd.dimension((function(d){return d.min_term_occurrence})),monthDimension=respd.dimension((function(d){return d3.timeYear(d.date)}));function accumulate_group(source_group){return{all:function(){var cumulate=0;return source_group.all().reverse().map((function(d){return cumulate+=d.value,{key:d.key,value:cumulate}}))}}}var accGroup=countDimension.group().reduceSum((function(d){return 1})),monthlyMoveGroup=monthDimension.group().reduceSum((function(d){return 1})),chartwidth=$("#time-graph").width(),e;timeChart.width(chartwidth-50).height(230).margins({top:10,right:50,bottom:30,left:50}).dimension(monthDimension).group(monthlyMoveGroup).centerBar(!0).colors(DATABASES[dbn].nonbgcolor).x(d3.scaleTime().domain((e=d3.extent(articles.results,(function(d){return d.date})),null==e[1]?e:(e[0]=new Date(e[0].getFullYear()-1,0,1),e[1]=new Date(e[1].getFullYear()+1,0,1),e)))).xAxisLabel("Years").yAxisLabel("Doc Count").alwaysUseRounding(!0).xUnits(d3.timeYear).elasticY(!0).round(d3.timeYear.round).yAxis().ticks(3),timeChart.xAxis().tickFormat(d3.timeFormat("%Y")),minSelect.width(chartwidth-50).height(130).margins({top:10,right:50,bottom:30,left:50}).dimension(countDimension).group(accGroup).centerBar(!1).colors(DATABASES[dbn].nonbgcolor).x(d3.scaleLinear().domain([0,maxCount+1])).alwaysUseRounding(!0).xAxisLabel("Occurrence of search term(s)").yAxisLabel("Doc Count").elasticY(!0).round((function(d){return Math.floor(d)})).yAxis().ticks(3),docCount.dimension(respd).group(all).html({some:"<strong id=\"final_count\">%filter-count</strong> selected out of <strong>%total-count</strong> records | <a href='javascript:dc.filterAll(); dc.renderAll();'>Reset All</a>",all:'<strong id="final_count">%total-count</strong> records selected. Please click and drag on the graph to apply filters.'}).on("renderlet",(function(d){0==d3.select("#explore-docs-div").classed("hidden")&&showContinue("filter-docs"),updateEstimatedTime(d.group().value(),dbn,"explore")})),dc.renderAll(),$(".explore-docs-btn").off("click"),$(".explore-docs-btn").click((function(e){$("doc-table-wrapper").scrollTop(0);let selected_docs=minSelect.dimension().top(100);console.log(selected_docs),console.log(database_runtimes[dbn].max),selected_docs.length>database_runtimes[dbn].max&&alert("Warning!\nIf you continue with this number of documents we will cut the model to "+database_runtimes[dbn].max+" documents at runtime to save our poor servers.\nPlease contact us at mccabeen@ucmail.uc.edu if you want to run extra large models"),showContinue("explore-docs"),renderExploreDocs(selected_docs,dbn,qry,fromhistory,total_articles)}));let table_last_refreshed_height=0,displayed_rows=100;var ys,ye;($("#doc-table-wrapper").on("scroll",e=>{const almost_hitting_scroll_end=Math.abs(e.target.scrollHeight-e.target.clientHeight-e.target.scrollTop)<Math.abs(.3*e.target.scrollHeight);if(almost_hitting_scroll_end&&table_last_refreshed_height<e.target.scrollHeight&&displayed_rows<total_articles){table_last_refreshed_height=e.target.scrollHeight,displayed_rows=displayed_rows+100<total_articles?displayed_rows+100:total_articles;const filteredData=minSelect.dimension().top(displayed_rows);renderTableBody(filteredData,dbn)}}),fromhistory)&&(-1!=restoredFilters.ys&&"year"!=restoredFilters.ys&&(ys=dateFormatParser(restoredFilters.ys+"-01-01"),ye=dateFormatParser(restoredFilters.ye+"-01-01"),datefilter=dc.filters.RangedFilter(ys,ye),timeChart.filter(datefilter)),-1!=restoredFilters.min&&(minfilter=dc.filters.RangedFilter(restoredFilters.min,restoredFilters.max),minSelect.filter(minfilter)),dc.renderAll(),$(".explore-docs-btn").trigger("click"))}function updateFilters(){var yearlabeltext=d3.select("#label_for_month_bar").text(),countlabeltext=d3.select("#label_for_count_bar").text(),yearArr=["-1","-1"];yearlabeltext.length>0&&(yearArr=prepareDates(yearlabeltext));var countArr=["-1","-1"];return countlabeltext.length>0&&(countArr=prepareCounts(countlabeltext)),{years:yearArr,counts:countArr}}function prepareDates(labelstring){var cut=labelstring.slice(1,labelstring.length-1).split(" ");return[cut[0].split("/")[2],cut[2].split("/")[2]]}function prepareCounts(labelstring){var cut=labelstring.slice(1,labelstring.length-1).split(" ");return[cut[0].split(".")[0],cut[2].split(".")[0]]}function updateEstimatedTime(selected,dbn,pre){let est_time=database_runtimes[dbn].a*selected+database_runtimes[dbn].b,formatted_est_time=new Date(1e3*est_time).toISOString().substr(11,8);return $("."+pre+"-estimated-time").text(formatted_est_time),"vis"==pre&&$(".filtered-count").text(selected),est_time>1200?($("."+pre+"-docs-btn").css("background-color","red"),$("."+pre+"-estimated-time").css("color","red"),"red"):est_time>600?($("."+pre+"-docs-btn").css("background-color","orange"),$("."+pre+"-estimated-time").css("color","orange"),"orange"):est_time>200?($("."+pre+"-docs-btn").css("background-color","yellow"),$("."+pre+"-estimated-time").css("color","#999900"),"#999900"):($("."+pre+"-docs-btn").css("background-color","green"),$("."+pre+"-estimated-time").css("color","green"),"green")}function renderTHead(articles_length,dbn){d3.select(".tdoc-head").remove(),d3.select(".tdoc-body").remove();var table=d3.select(".dc-doc-table"),thead=table.append("thead").attr("class","tdoc-head"),tbody=table.append("tbody").attr("class","tdoc-body"),columns=["article_title","date","score","included"];thead.append("tr").selectAll("th").data(columns).enter().append("th").attr("class","col tdoc-th").text((function(column){return"article_title"==column?"Article Title":"id"==column?"Id":column})).style("width",(function(column){return"article_title"==column?"50%":"25%"})).attr("id",(function(column){if("included"==column)return"select-all-docs"})).style("cursor",(function(column){return"included"==column?"pointer":"default"})),excludedDocs=[],includedDocs=[],prevChecked=!0,$("#select-all-docs").click((function(){prevChecked=!prevChecked,includedDocs=[],excludedDocs=[],prevChecked?($(".tr-check").prop("checked",!0),$(".filtered-count").css("color",updateEstimatedTime(articles_length,dbn,"vis"))):($(".tr-check").prop("checked",!1),$(".filtered-count").css("color",updateEstimatedTime(0,dbn,"vis")))}))}function renderTable(filteredData,dbn,qry){var checked_columns;includedDocs=[],excludedDocs=[],d3.selectAll(".tdoc-row").remove(),renderTableBody(filteredData,dbn),d3.selectAll(".td-included").append("input").attr("type","checkbox").attr("class","tr-check").property("checked",prevChecked).on("click",(function(d,i){var inthere=$(this).prop("checked"),document_id=filteredData[i].id;prevChecked?inthere?(excludedDocs=excludedDocs.filter((function(a){return a!=document_id})),$(".filtered-count").css("color",updateEstimatedTime(filteredData.length-excludedDocs.length,dbn,"vis"))):(excludedDocs.push(document_id),$(".filtered-count").css("color",updateEstimatedTime(filteredData.length-excludedDocs.length,dbn,"vis"))):inthere?(includedDocs.push(document_id),$(".filtered-count").css("color",updateEstimatedTime(includedDocs.length,dbn,"vis"))):(includedDocs=includedDocs.filter((function(a){return a!=document_id})),$(".filtered-count").css("color",updateEstimatedTime(includedDocs.length,dbn,"vis"))),console.log(includedDocs),console.log(excludedDocs)})),$(".dc-doc-table>tbody>tr:first").trigger("click"),$(".td-included").addClass("hidden"),$("#select-all-docs").addClass("hidden")}const count=(str,regexp)=>{const re=regexp;return((str||"").match(re)||[]).length};function renderTableBody(filteredData,dbn){var columns=["article_title","date","score","included "],tbody,rows;d3.select(".tdoc-body").selectAll("tr").data(filteredData).enter().append("tr").attr("class","tdoc-row").on("click",(function(d){0!=d&&(d3.selectAll(".rowselected").classed("rowselected",!1).style("background-color",""),d3.select(this).classed("rowselected",!0).style("background-color",DATABASES[dbn].color),refreshArticle(d.id,"Pubmed Article",dbn))})).selectAll("td").data((function(row){return columns.map((function(column){return"score"==column?{column:column,value:row.min_term_occurrence}:{column:column,value:row[column]}}))})).enter().append("td").text((function(d){if("id"==d.column){if(d.value.length>10){let mid=Math.ceil(d.value.length/2);return d.value.slice(0,mid)+" "+d.value.slice(mid)}return d.value}return"date"==d.column?d3.timeYear(d.value).getFullYear():d.value})).attr("class",(function(d){return"td-"+d.column}))}async function refreshArticle(article_id,article_type,dbn){let article=await d3.json("/searcher/get_doc/?database="+dbn+"&doc_id="+article_id);console.log(article),$("#article-title").text(article.summary.article_title),$("#article-id").text(article.summary.id),$("#article-journal").text(article.summary.journal_title),$("#article-year").text(article.summary.year),$("#article-author").text(article.summary.author);let article_text=article.data;article_text=article_text.replace("<PubmedArticle>",""),article_text=article_text.replace("</PubmedArticle>","");let article_paras=article_text.split("\n");for(var i=0;i<article_paras.length;i++)article_paras[i]='<p class="article-p">'+article_paras[i]+"</p>";let articletext=article_paras.join("");function hiliter(word,element){var rgxp=new RegExp(word,"g"),crgxp=new RegExp(word.charAt(0).toUpperCase()+word.slice(1),"g"),ccrgxp=new RegExp(word.toUpperCase(),"g"),repl='<span class="highlighted">'+word+"</span>",crepl='<span class="highlighted">'+word.charAt(0).toUpperCase()+word.slice(1)+"</span>",ccrepl='<span class="highlighted">'+word.toUpperCase()+"</span>",c1,c2,c3,matchCount;return element.html(element.html().replace(rgxp,repl)),element.html(element.html().replace(crgxp,crepl)),element.html(element.html().replace(ccrgxp,ccrepl)),count(articletext,rgxp)+count(articletext,crgxp)+count(articletext,ccrgxp)}$("#article-panel").html("<result>"+articletext+"</result>"),$("#search-article-text").val(""),$("#article-search-count").text(""),$("#article-search-box").css("opacity","0").css("visibility","hidden"),$("#search-article-text").on("change",(function(e){$("#article-panel").html("<result>"+articletext+"</result>"),$("#article-search-count").text(""),$("#article-search-box").css("opacity","0").css("visibility","hidden"),0!=$(this).val().length&&($("#article-search-count").text("Matches : "+hiliter($(this).val(),$("#article-panel"))),$("#article-search-box").css("opacity","1").css("visibility","visible"))}))}function renderExploreDocs(articles,dbn,qry,fromhistory,total_docs){if(console.log(dbn),renderTHead(articles.length,dbn,fromhistory),renderTable(articles,dbn,qry,fromhistory),$(".article-div").css("background-color",DATABASES[dbn].color),$(".filtered-count").text(total_docs),$(".total-filtered-count").text(total_docs),$(".filtered-count").css("color",updateEstimatedTime(total_docs,dbn,"vis")),$("#choose-vis-btn").on("click",(function(d){showContinue("select-vis"),renderVisSelect(dbn,qry,fromhistory)})),"JSTOR"==dbn){$("#download-table-btn").removeClass("hidden");var downloadcsvformat=[];$("#download-table-btn").click((function(){var docrows;d3.selectAll(".tdoc-row").each((function(d){d3.select(this).select(".td-included").select("input").property("checked")&&downloadcsvformat.push(d)}));let csvstring="";var regex=/ , /g;downloadcsvformat.forEach((function(d){Object.keys(downloadcsvformat[0]).forEach((function(k){csvstring="authors"==k?csvstring+d[k].replace(regex,"-")+", ":csvstring+d[k]+", "})),csvstring+="\r\n"})),console.log(csvstring)}))}if(fromhistory){console.log(restoredFilters.listtype);var restoredDocsList=restoredFilters.docs.split("-");restoredDocsList.shift(),"select"==restoredFilters.listtype?($("#select-all-docs").trigger("click"),d3.selectAll(".tdoc-row").attr("nothing",(function(d,i){for(var i=0;i<restoredDocsList.length;i++)restoredDocsList[i]==d.id&&(d3.select(this).select(".tr-check").property("checked",!0),d3.select(this).select(".tr-check").dispatch("click"),i=restoredDocsList.length)}))):d3.selectAll(".tdoc-row").attr("nothing",(function(d,i){for(var i=0;i<restoredDocsList.length;i++)restoredDocsList[i]==d.id&&(d3.select(this).select(".tr-check").property("checked",!1),d3.select(this).select(".tr-check").dispatch("click"),i=restoredDocsList.length)})),$("#choose-vis-btn").trigger("click")}}function renderVisSelect(dbn,qry){$(".fig.db-button").css("background-color",DATABASES[dbn].color),$(".fig.db-button").css("border-color","white"),$(".fig").on("click",(function(d){showContinue("vis-params"),renderVisParams(dbn,qry,$(this).attr("id"))})),fromhistory=!1}const MAX_TOPICS=50,MIN_TOPICS=1;function renderVisParams(dbn,qry,method,fromhistory){$("#submit-wrapper-button").off("click"),$("#method-name").text(method),$("#num_topics").change((function(e){$("#num_topics").val()>50&&$("#num_topics").val(50),$("#num_topics").val()<1&&$("#num_topics").val(1)})),$("#num_clusters").change((function(e){$("#num_clusters").val()>50&&$("#num_clusters").val(50),$("#num_clusters").val()<1&&$("#num_clusters").val(1)})),console.log(method),$("#form-div").css("background-color",DATABASES[dbn].color),"DFR browser"==method&&($("#mlmom-options").addClass("hidden"),$(".not-w2v").removeClass("hidden"),$(".lda-options").removeClass("hidden"),$(".vector-options").addClass("hidden"),$("#word2vec-doc2vec-chooser").addClass("hidden")),"pyLDAvis"==method&&($("#mlmom-options").addClass("hidden"),$(".not-w2v").removeClass("hidden"),$(".lda-options").removeClass("hidden"),$(".vector-options").addClass("hidden"),$("#word2vec-doc2vec-chooser").addClass("hidden")),"multilevel_lda"==method&&($(".lda-options").removeClass("hidden"),$(".not-w2v").removeClass("hidden"),$("#mlmom-options").removeClass("hidden"),$(".vector-options").addClass("hidden"),$("#word2vec-doc2vec-chooser").addClass("hidden")),"word2vec"!=method&&"doc2vec"!=method||($("#mlmom-options").addClass("hidden"),$("#params-label").text("Word2Vec/Doc2Vec Parameters"),$(".not-w2v").addClass("hidden"),$(".vector-options").removeClass("hidden"),$(".lda-options").removeClass("hidden"),$("#word2vec-doc2vec-chooser").removeClass("hidden"),$("#doc2vec-radio").on("click",(function(d){method="doc2vec",$("#method-name").text(method),$("#static-method").val(method)})),$("#word2vec-radio").on("click",(function(d){method="word2vec",$("#method-name").text(method),$("#static-method").val(method)}))),"sentiment"==method&&$("#sentiment-options").removeClass("hidden"),$("#static-method").val(method),$("#submit-wrapper-button").click((function(e){var filters=updateFilters(),postObj={start:search_year_start,end:search_year_end,f_start:filters.years[0],f_end:filters.years[1],qry:qry,ngrams:$("#ngrams-check").prop("checked"),tfidf:$("#tfidf-check").prop("checked"),maximum_hits:size,method:method,stop_words:$("#stop-word").val(),replacement:$("#word-replacement").val(),phrases:$("#phrases").val(),level_select:$("#level-select").val(),num_topics:$("#num_topics").val(),num_clusters:$("#num_clusters").val(),passes:20,database:selected_database,journal:$("#journal-options-select").val(),jurisdiction_select:$("#law-options-select").val(),min_care_rating:$("#care_rating_low").val(),auth_s:$("#search-author").val(),family_select:$("#family-options-select").val(),included:includedDocs,excluded:excludedDocs,min_occurrence:filters.counts[0],max_occurrence:filters.counts[1],doc_count:d3.select("#final_count").text(),sentiment_select:$("#sentiment-select").val()};console.log(postObj),$.post("/searcher/start_model_run/",postObj,(function(d){let response=JSON.parse(d);console.log(response),$("#pk_text").val(response.filter_pk),$("#run-model").submit()}))}))}function showContinue(prefix,direction){let sections=["database-select","search-text","filter-docs","explore-docs","select-vis","vis-params"],currentIndex=sections.indexOf(prefix),nextIndex="next"===direction?currentIndex+1:currentIndex-1;$("#"+prefix+"-div").addClass("hidden"),$("#"+prefix+"-nav").addClass("disabled"),$("#"+prefix+"-nav").removeClass("side-nav-active"),$("#"+sections[nextIndex]+"-div").removeClass("hidden"),$("#"+sections[nextIndex]+"-nav").removeClass("disabled"),$("#"+sections[nextIndex]+"-nav").addClass("side-nav-active"),$("#"+sections[nextIndex]+"-nav").trigger("click")}function hexToRgb(hex){var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:null}function componentToHex(c){var hex=c.toString(16);return 1==hex.length?"0"+hex:hex}function rgbToHex(r,g,b){return"#"+componentToHex(r)+componentToHex(g)+componentToHex(b)}$(".prev").on("click",(function(e){let currentSection;e.preventDefault(),showContinue($(".side-nav-active").attr("id").replace("-nav",""),"prev")}));let includedDocs=[],excludedDocs=[],prevChecked=!1;function getCookie(name){var cookieValue=null;if(document.cookie&&""!==document.cookie)for(var cookies=document.cookie.split(";"),i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)===name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}return cookieValue}var csrftoken=getCookie("csrftoken");function csrfSafeMethod(method){return/^(HEAD|OPTIONS|TRACE)$/.test(method)}$.ajaxSetup({beforeSend:function(xhr,settings){csrfSafeMethod(settings.type)||this.crossDomain||xhr.setRequestHeader("X-CSRFToken",csrftoken)}});let DATABASES={ACJ:{options:[],name:"AC Justice "},AA:{options:[],name:"Anesthesiology"},Archaeology:{options:[{type:"select",choices:{name:"Journal",selects:["all","Latin American Antiquity","Ancient Mesoamerica"]}}],name:"Archaeology"},CaseLaw_v2:{options:[{type:"select",choices:{name:"Jurisdiction",selects:["all","federal","other"]}}],name:"CaseLaw"},caselaw_env:{options:[],name:"CaseLaw Environment"},"chicago-novels":{options:[],name:"Chicago Corpus"},Covid:{options:[],name:"COVID-19 Articles"},early_modern:{options:[],name:"Early Modern JSTOR"},Ehealth:{options:[],name:"Ehealth Alzheimer"},Care_Reviews:{options:[],name:"ER, Urgent Care Reviews"},Hathi_Climate:{options:[],name:"Hathi Climate"},Hathi_Rand:{options:[],name:"Hathi Random"},Latin:{options:[],name:"Iowa Latin Canon"},JSTOR:{options:[],name:"Jstor Life Science"},News_Articles:{options:[],name:"News Articles"},China_news:{options:[],name:"News Transcripts - China"},Mayerson:{options:[],name:"Mayerson"},Mayerson_qna:{options:[],name:"Mayerson QNA"},Med_Applications:{options:[],name:"Med Applications"},NYT_China:{options:[],name:"NYT China"},NYNPO_taxforms:{options:[],name:"NY NPO Descriptions"},Poetry_Foundation:{options:[],name:"Poetry Foundation"},Pubmed:{options:[],name:"Pubmed Abstract"},PMC:{options:[],name:"Pubmed Central"},TCP:{options:[],name:"Text Creation"},CCHMC:{options:[],name:"CCHMC Notes"},Pulmonary:{options:[],name:"Pulmonary"},OHNPO_taxforms:{options:[],name:"OH NPO Descriptions"},Pubmed_COI:{options:[],name:"Pubmed COI"},Reddit:{options:[],name:"Reddit"},SAA_Abstracts:{options:[],name:"SAA Abstracts"},space_news:{options:[],name:"Space News Articles"},US_Poetics:{options:[],name:"US Poetics"},WSJ_China:{options:[],name:"WSJ China"},WAPO_China:{options:[],name:"WAPO China"},space_tvnews:{options:[],name:"Space TV News"}};function getJsonFromUrl(hashBased){var query;if(hashBased){var pos=location.href.indexOf("?");if(-1==pos)return[];query=location.href.substr(pos+1)}else query=location.search.substr(1);var result={};return query.split("&").forEach((function(part){if(part){var eq=(part=part.split("+").join(" ")).indexOf("="),key=eq>-1?part.substr(0,eq):part,val=eq>-1?decodeURIComponent(part.substr(eq+1)):"",from=key.indexOf("[");if(-1==from)result[decodeURIComponent(key)]=val;else{var to=key.indexOf("]",from),index=decodeURIComponent(key.substring(from+1,to));key=decodeURIComponent(key.substring(0,from)),result[key]||(result[key]=[]),index?result[key][index]=val:result[key].push(val)}}})),result}console.log(Object.keys(DATABASES)),Object.keys(DATABASES).forEach((function(db,index){console.log(db);let otherColorElement=d3.select("#other-color"),thirdColorElement=d3.select("#third-color");if(otherColorElement.empty()||thirdColorElement.empty())console.error("Could not find #other-color or #third-color elements");else{let color=d3.color(otherColorElement.style("color")).hex(),third_color=d3.color(thirdColorElement.style("color")),rgbObj=hexToRgb(color);DATABASES[db].color=color,DATABASES[db].nonbgcolor=third_color;let databaseButton=d3.select("#select-db").append("button").attr("id",db+"_btn").text(db).style("background-color",DATABASES[db].color).style("color",DATABASES[db].nonbgcolor);DATABASES[db].button=databaseButton}}));let query_id_str="",restoredFilters={ys:-1,ye:-1,min:-1,max:-1},loaded=getJsonFromUrl(window.location.search),fromhistory=!1;async function wrapper(){d3.select("#navbarDropdown").on("click",(function(e){d3.select("#account_dropdown").classed("show",!d3.select("#account_dropdown").classed("show"))})),$((function(){$('[data-toggle="popover"]').popover()})),$("#base-row").removeClass("justify-content-center").removeClass("align-items-center"),console.log(window.location.search),null!=loaded.qry?(restoredFilters=await d3.json("/get_stored_filter/?filter_id="+loaded.filter_pk),console.log(restoredFilters),console.log(loaded.database),query_id_str="&query_id="+loaded.query_id,fromhistory=!0,renderDataBaseSelect(DATABASES,fromhistory=!0)):renderDataBaseSelect(DATABASES),d3.selectAll(".section").style("height",(function(d){return"400px"})),$("#side-nav a").on("click",(function(event){if(""!==this.hash){event.preventDefault();var hash=this.hash;$(".content, html").animate({scrollTop:$(hash).offset().top},800,(function(){window.location.hash=hash}))}}))}wrapper();